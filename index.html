<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What's Flying in New York?</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:wght@400;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans Pro', -apple-system, sans-serif;
            background: #f5f3ef;
            color: #2c3e2d;
            min-height: 100vh;
        }

        header {
            background: #2c3e2d;
            color: #f5f3ef;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 70px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            font-size: 1.5rem;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .tagline {
            font-size: 0.85rem;
            opacity: 0.85;
            margin-top: 0.2rem;
            font-weight: 400;
        }

        h1 {
            font-family: 'Libre Baskerville', Georgia, serif;
            font-size: 1.4rem;
            font-weight: 400;
        }

        h1 span {
            color: #a8c686;
        }

        .header-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }

        .header-stat {
            text-align: center;
        }

        .header-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #a8c686;
        }

        .header-stat-label {
            opacity: 0.8;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 380px;
            height: calc(100vh - 70px);
            margin-top: 70px;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .sidebar {
            background: #fff;
            border-left: 1px solid #d4cfc7;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e8e4dc;
            background: #faf9f7;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sidebar-title {
            font-family: 'Libre Baskerville', serif;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .sidebar-subtitle {
            font-size: 0.8rem;
            color: #666;
        }

        .legend {
            display: flex;
            gap: 1rem;
            margin-top: 0.75rem;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .legend-dot.ultra { background: #c0392b; }
        .legend-dot.very { background: #e67e22; }
        .legend-dot.rare { background: #f1c40f; }
        .legend-dot.notable { background: #27ae60; }

        .bird-list {
            flex: 1;
            padding: 0.5rem 0;
        }

        .bird-card {
            padding: 0.875rem 1.25rem;
            border-bottom: 1px solid #f0ece6;
            cursor: pointer;
            transition: background 0.15s;
            display: grid;
            grid-template-columns: 60px 1fr;
            gap: 0.75rem;
        }

        .bird-card:hover {
            background: #faf9f7;
        }

        .bird-card.active {
            background: #e8f5e9;
            border-left: 3px solid #2c3e2d;
        }

        .bird-thumb {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            object-fit: cover;
            background: #e8e4dc;
        }

        .bird-thumb-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            background: linear-gradient(135deg, #e8e4dc 0%, #d4cfc7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #999;
        }

        .bird-content {
            min-width: 0;
        }

        .bird-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .bird-name {
            font-family: 'Libre Baskerville', serif;
            font-size: 0.95rem;
            font-weight: 400;
            color: #2c3e2d;
        }

        .bird-rank {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            white-space: nowrap;
        }

        .bird-rank.ultra { background: #fadbd8; color: #922b21; }
        .bird-rank.very { background: #fdebd0; color: #9c640c; }
        .bird-rank.rare { background: #fcf3cf; color: #7d6608; }
        .bird-rank.notable { background: #d5f5e3; color: #1e8449; }

        .bird-scientific {
            font-style: italic;
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.15rem;
        }

        .bird-meta {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: #555;
        }

        .bird-meta-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .bird-locations {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #777;
        }

        .sidebar-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid #e8e4dc;
            background: #faf9f7;
            font-size: 0.75rem;
            color: #666;
        }

        .sidebar-footer a {
            color: #2c3e2d;
        }

        /* Map popup styles */
        .leaflet-popup-content-wrapper {
            border-radius: 4px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.15);
        }

        .leaflet-popup-content {
            margin: 0;
            min-width: 220px;
        }

        .popup-content {
            padding: 0.75rem;
        }

        .popup-location {
            font-weight: 600;
            font-size: 0.9rem;
            color: #2c3e2d;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        .popup-bird {
            padding: 0.5rem 0;
            border-bottom: 1px solid #f5f5f5;
            display: grid;
            grid-template-columns: 50px 1fr;
            gap: 0.5rem;
            align-items: start;
        }

        .popup-bird:last-child {
            border-bottom: none;
        }

        .popup-bird-img {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            object-fit: cover;
            background: #eee;
        }

        .popup-bird-img-placeholder {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            background: linear-gradient(135deg, #e8e4dc 0%, #d4cfc7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .popup-bird-info {
            min-width: 0;
        }

        .popup-bird-name {
            font-family: 'Libre Baskerville', serif;
            font-size: 0.85rem;
        }

        .popup-bird-details {
            font-size: 0.72rem;
            color: #666;
            margin-top: 0.15rem;
            line-height: 1.3;
        }

        .popup-bird-link {
            font-size: 0.7rem;
            color: #2980b9;
            text-decoration: none;
        }

        .popup-bird-link:hover {
            text-decoration: underline;
        }

        .last-updated {
            text-align: center;
            font-size: 0.7rem;
            color: #888;
            padding: 0.5rem;
        }

        /* Custom marker styles */
        .custom-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            font-size: 10px;
            font-weight: 600;
            color: #fff;
        }

        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: 50vh 1fr;
            }

            .sidebar {
                border-left: none;
                border-top: 1px solid #d4cfc7;
            }

            header {
                padding: 0.75rem 1rem;
            }

            h1 {
                font-size: 1.1rem;
            }

            .header-stats {
                gap: 1rem;
            }
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }

        /* Floating map controls */
        .map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .map-btn {
            background: #fff;
            border: none;
            padding: 10px 14px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            cursor: pointer;
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            color: #2c3e2d;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.15s;
        }

        .map-btn:hover {
            background: #f0f0f0;
        }

        .sidebar-toggle {
            display: none;
        }

        .sidebar.hidden {
            display: none;
        }

        .main-container.sidebar-hidden {
            grid-template-columns: 1fr;
        }

        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: 60vh 1fr;
                margin-top: 70px;
            }

            .sidebar {
                border-left: none;
                border-top: 1px solid #d4cfc7;
            }

            header {
                padding: 0.75rem 1rem;
            }

            h1 {
                font-size: 1.1rem;
            }

            .header-stats {
                gap: 1rem;
            }

            .sidebar-toggle {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <span class="logo-icon">üî≠</span>
            <div class="logo-text">
                <h1>What's Flying in <span>New York</span>?</h1>
                <p class="tagline">Notable sightings reported to eBird over the past 7 days</p>
            </div>
        </div>
        <div class="header-stats">
            <div class="header-stat">
                <div class="header-stat-value" id="species-count">-</div>
                <div class="header-stat-label">Species</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="sighting-count">-</div>
                <div class="header-stat-label">Sightings</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="location-count">-</div>
                <div class="header-stat-label">Locations</div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <div id="map">
            <div class="loading">Loading map...</div>
            <div class="map-controls">
                <button class="map-btn" onclick="resetMapView()" title="Reset to New York">
                    üó∫Ô∏è Reset View
                </button>
                <button class="map-btn sidebar-toggle" onclick="toggleSidebar()" title="Toggle species list">
                    üìã Species List
                </button>
            </div>
        </div>
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-subtitle">Click to locate on map</div>
                <div class="sidebar-subtitle">Birds below are sorted by rarity</div>
                <div class="legend">
                    <div class="legend-item"><span class="legend-dot ultra"></span> Ultra-rare</div>
                    <div class="legend-item"><span class="legend-dot very"></span> Very rare</div>
                    <div class="legend-item"><span class="legend-dot rare"></span> Rare</div>
                    <div class="legend-item"><span class="legend-dot notable"></span> Notable</div>
                </div>
            </div>
            <div class="bird-list" id="bird-list">
                <div class="loading">Loading species...</div>
            </div>
            <div class="sidebar-footer">
                <p>Data from <a href="https://ebird.org" target="_blank">eBird</a> by Cornell Lab of Ornithology</p>
                <p class="last-updated" id="last-updated"></p>
            </div>
        </aside>
    </div>

    <script>
        let map;
        let markers = [];
        let birdData = [];
        let defaultBounds = null;

        function resetMapView() {
            if (defaultBounds) {
                map.fitBounds(defaultBounds, { padding: [30, 30] });
            } else {
                map.setView([42.5, -75.5], 7);
            }
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const container = document.querySelector('.main-container');
            sidebar.classList.toggle('hidden');
            container.classList.toggle('sidebar-hidden');
            map.invalidateSize();
        }

        function getRarityClass(rank, total) {
            const percentile = rank / total;
            if (percentile <= 0.1) return 'ultra';
            if (percentile <= 0.25) return 'very';
            if (percentile <= 0.5) return 'rare';
            return 'notable';
        }

        function getRarityColor(rarityClass) {
            const colors = {
                'ultra': '#c0392b',
                'very': '#e67e22',
                'rare': '#f1c40f',
                'notable': '#27ae60'
            };
            return colors[rarityClass] || '#27ae60';
        }

        function getRarityLabel(rarityClass) {
            const labels = {
                'ultra': 'Ultra-rare',
                'very': 'Very rare',
                'rare': 'Rare',
                'notable': 'Notable'
            };
            return labels[rarityClass] || 'Notable';
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function createMarker(lat, lng, birds, rarityClass) {
            const color = getRarityColor(rarityClass);
            const size = rarityClass === 'ultra' ? 28 : rarityClass === 'very' ? 24 : rarityClass === 'rare' ? 20 : 16;

            const icon = L.divIcon({
                className: 'custom-marker-wrapper',
                html: `<div class="custom-marker" style="width:${size}px;height:${size}px;background:${color}">${birds.length > 1 ? birds.length : ''}</div>`,
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            });

            const marker = L.marker([lat, lng], { icon });

            // Build popup content
            const locationName = birds[0].locName;
            const popupHtml = `
                <div class="popup-content">
                    <div class="popup-location">${locationName}</div>
                    ${birds.slice(0, 5).map(b => `
                        <div class="popup-bird">
                            ${b.imageUrl
                                ? `<img src="${b.imageUrl}" alt="${b.comName}" class="popup-bird-img" loading="lazy">`
                                : `<div class="popup-bird-img-placeholder">üê¶</div>`
                            }
                            <div class="popup-bird-info">
                                <div class="popup-bird-name">${b.comName}</div>
                                <div class="popup-bird-details">
                                    ${formatDate(b.obsDt)} ¬∑ ${b.howMany || 1} bird${(b.howMany || 1) > 1 ? 's' : ''}
                                </div>
                                ${b.subId ? `<a href="https://ebird.org/checklist/${b.subId}" target="_blank" class="popup-bird-link">View on eBird ‚Üí</a>` : ''}
                            </div>
                        </div>
                    `).join('')}
                    ${birds.length > 5 ? `<div style="font-size:0.75rem;color:#666;padding-top:0.5rem;text-align:center;">+${birds.length - 5} more sightings</div>` : ''}
                </div>
            `;

            marker.bindPopup(popupHtml, { maxWidth: 300 });
            return marker;
        }

        function groupByLocation(species) {
            const locations = {};

            species.forEach(sp => {
                sp.observations.forEach(obs => {
                    if (!obs.lat || !obs.lng) return;

                    // Round to ~100m precision for grouping nearby spots
                    const key = `${obs.lat.toFixed(3)},${obs.lng.toFixed(3)}`;

                    if (!locations[key]) {
                        locations[key] = {
                            lat: obs.lat,
                            lng: obs.lng,
                            birds: [],
                            bestRank: Infinity
                        };
                    }

                    locations[key].birds.push({
                        ...obs,
                        comName: sp.comName,
                        sciName: sp.sciName,
                        rarityRank: sp.rarityRank,
                        imageUrl: sp.imageUrl
                    });

                    if (sp.rarityRank < locations[key].bestRank) {
                        locations[key].bestRank = sp.rarityRank;
                    }
                });
            });

            return Object.values(locations);
        }

        function renderBirdList(species, totalSpecies) {
            const listEl = document.getElementById('bird-list');

            const html = species.map(sp => {
                const rarityClass = getRarityClass(sp.rarityRank, totalSpecies);
                const latestObs = sp.observations[0];
                const locationCount = new Set(sp.observations.map(o => o.locName)).size;

                const thumbHtml = sp.imageUrl
                    ? `<img src="${sp.imageUrl}" alt="${sp.comName}" class="bird-thumb" loading="lazy">`
                    : `<div class="bird-thumb-placeholder">üê¶</div>`;

                return `
                    <div class="bird-card" data-species="${sp.speciesCode}">
                        ${thumbHtml}
                        <div class="bird-content">
                            <div class="bird-header">
                                <div>
                                    <div class="bird-name">${sp.comName}</div>
                                    <div class="bird-scientific">${sp.sciName}</div>
                                </div>
                                <span class="bird-rank ${rarityClass}">#${sp.rarityRank}</span>
                            </div>
                            <div class="bird-meta">
                                <span class="bird-meta-item">üìç ${locationCount}</span>
                                <span class="bird-meta-item">üëÅ ${sp.totalObservations}</span>
                            </div>
                            <div class="bird-locations">
                                ${latestObs.locName}
                                ${latestObs.subId ? `¬∑ <a href="https://ebird.org/checklist/${latestObs.subId}" target="_blank" style="color:#2980b9">eBird</a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            listEl.innerHTML = html;

            // Add click handlers
            document.querySelectorAll('.bird-card').forEach(card => {
                card.addEventListener('click', () => {
                    const speciesCode = card.dataset.species;
                    const sp = species.find(s => s.speciesCode === speciesCode);
                    if (sp && sp.observations[0].lat) {
                        map.setView([sp.observations[0].lat, sp.observations[0].lng], 12);

                        // Highlight card
                        document.querySelectorAll('.bird-card').forEach(c => c.classList.remove('active'));
                        card.classList.add('active');
                    }
                });
            });
        }

        async function init() {
            // Initialize map centered on NY
            map = L.map('map').setView([42.5, -75.5], 7);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            try {
                const response = await fetch('data/birds.json');
                if (!response.ok) throw new Error('Data not found');

                const data = await response.json();
                birdData = data.species;

                // Update stats
                document.getElementById('species-count').textContent = data.totalSpecies;
                document.getElementById('sighting-count').textContent = data.totalObservations;

                const locations = groupByLocation(data.species);
                document.getElementById('location-count').textContent = locations.length;

                // Update timestamp
                const updated = new Date(data.lastUpdated);
                document.getElementById('last-updated').textContent = `Updated ${updated.toLocaleDateString('en-US', {
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                })}`;

                // Add markers
                locations.forEach(loc => {
                    const rarityClass = getRarityClass(loc.bestRank, data.totalSpecies);
                    const marker = createMarker(loc.lat, loc.lng, loc.birds, rarityClass);
                    marker.addTo(map);
                    markers.push(marker);
                });

                // Render bird list
                renderBirdList(data.species, data.totalSpecies);

                // Fit bounds if we have markers
                if (locations.length > 0) {
                    const bounds = L.latLngBounds(locations.map(l => [l.lat, l.lng]));
                    defaultBounds = bounds;
                    map.fitBounds(bounds, { padding: [30, 30] });
                }

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('bird-list').innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #666;">
                        <p>Unable to load bird data.</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">Please try again later.</p>
                    </div>
                `;
            }
        }

        init();
    </script>
</body>
</html>
